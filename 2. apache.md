# apache HTTP Server 
он будет разобран детально, так как система очень массовая, очень гибкая, от того уязвимостей в ней много и часть из них абсолютно не принимы при различных обстоятельствах.  
## распространённость и иная общедоступная информация 
кроссплатформенный свободно распространяемый веб-сервер.  
С апреля 1996 и до настоящего времени является самым популярным HTTP-сервером в Интернете.  
язык: C  
дата создания: 1995  
ирония: назывался в шутку «в заплатках», так как закрывал заплатками ошибки NCSA, а теперь сам весь в заплатках.  
конфигурация: текстовые *.conf файлы (httpd.conf - по умолчанию, extra/httpd-vhosts.conf - для виртуальных хостов)  
 
 
 
## "детские" проблемы 
* запуск от УЗ с избыточными привилегиями 
* включенный модуль выполнения php без нужды 
* возможность загружать файлы без проверок 
* ошибка конфигурации и возможность использовать ../../ в URL 
* ошибки в back-end сайтов, которые находятся на веб-сервере. 
 
 
 
## определения наличия на узле 
### сетевой 
если доступ к узлу только сетевой и сканнер является удаленным:  
nmap, скорее всего нас будут интересовать только порты 80 и 443, но хорошо также 8080 (-p80,443,8080). (хотя -p- тоже прекрасно, если один из сервисов http)  
в возвращаемых данных будет заголовок http-server-header Apache/*  
также можно воспользоваться скриптом для nmap http-apache-server-status  
что нам важно вытащить из этой информации: версию Apache  
также неплохо понять что за операционная система перед нами (так как сервер является кросс платформенным), осмотрев хост по всем портам (-p-), по всем доступным портам общим сканом (-A)  
 
 
 
### если есть edr или шелл на хост 
значит у нас фактически есть данные какая ОС на хосте  
для Debian/Ubuntu Linux необходимо выполнить команду apache2 -v  
CentOS/RHEL/Fedora Linux server: httpd -v  
для Windows необходимо найти httpd.exe (если он не прописан в PATH) и использовать команду ":\[Apache directories]\bin\httpd.exe" -v  
собственно отзыв по команде и сравнение версий с реальностью нам даст информацию о факте установки.  
также необходимо проверить факт запуска приложения: sudo ss -ltnup | grep "apache"  
 
 
## получив версию  
получив версию мы понимаем какие уязвимости вообще применимы.  
то есть, если у нас установлен Apache 2.4.50, в котором исправлены уязвимости: CVE-2021-41524 и CVE-2021-41773, проверить их, конечно, можно, но вероятность крайне мала, тоже касается уязвимостей в более ранних версиях. 
 
 
## работа с известными уязвимостями 
все уязвимости можно разделить на несколько категорий 
* работа с путем внутри, например: 
    CVE-2021-41773, закрытая 2.4.49 в связке с миссконфигом, которые давали читать ../../../../etc/passwd и выполнять код  
    для проверки нужно знать: 
    + версия ПО 
    + параметр конфигов, определяющий возможности использования alias-ов 
* работа с файлами, определенного расширения, лежащими внутри сайта, например: 
    CVE-2021-44790, закрыта 2.4.51, при обращении к lua-файлу с правильными заголовками можно "положить" веб-сервер  
    для проверки нужно знать: 
    + версию ПО 
    + файловую структуру внутри веб сервера 
    + параметр конфига можно ли загружать файлы на веб-сервер из веба (или параметры бэкэнда) 
    + блэклистинг расширений файлов в конфиге, которые отображаются на сайте 
* общеизвестные проблемы бэкенда, по типу SQL инъекций, LFE, RFE 
 
 
# итого 
## приоритет 
высокий, так как: 
1) массовая. в мире каждый третий заказчик 
1) массовая в РФ. может быть установлена у каждого 6го заказчика; 
1) часто является основой другого ПО, администрирование которого осуществляется на базе Apache HTTP server ; 
2) описанная. по ней куча информации, по настройкам; 
3) вендор ведет patch notes и описания релизов с закрытыми уязвимостями; 
4) opensource, можно развернуть в лаборатории и тестировать как угодно; 
5) ПОКи скриптов. 
 
 
## модель данных для Apache HTTP server  
* конфиг с разделением с каждым виртуальным сайтом 
* версия 
* дерево файлов и папок 
* cwd 
* если нужен респонз, то ID приложений веб-сервера 
* запускается ли включении хоста и чем 
* под какой УЗ 
* запущено сейчас 
* установленные расширения поверх (их имя, версия, если висят на другом порту, то каком и в какую сеть) 
* дерево сайтов c директориями и алиасами
* доступы (require)
 
 
## архитектура проверки 
* обнаружение узла (сетевой скан) 
* обнаружение ПО на узле (сетевой скан и запуск команд на хосте) 
* сбор информации о ПО (сетевой скан и запуск команд на хосте) 
* сбор статуса: запущено, куда смотрит ((сетевой скан и запуск команд на хосте)) 
* проверка версии, если на существующую версию есть уязвимости (работа с моделью)  
    результат: отображение применимых в теории уязвимостей 
* проверка конфигов и модели на применимость уязвимостей (работа с моделью)  
    результат: повышение уровня важности подошедших уязвимостей из первого списка  
    процесс: если есть бюллетень или описание как можно закрыть уязвимость, то при внесении CVE  в продукт необходимо указывать на какие параметры в модели завязана уязвимость  
    например: в модели для Apache HTTP server нужно хранить настройки из конфига и проверки доступов, потому как в конфиге можно на все сайты в веб-сервере повешать "require all denied", на путь /, тогда реализовать уязвимость не будет возможным вне зависимости от версии.
* запуск скриптов PenTest для фактической проверки, на подходящие уязвимости (модуль сетевого пентеста)  
    результат: при успешном прохождении теста на проникновение, максмальное повышение значимости уязвимости из первого списка. 
* (опционально) запуск скриптов PenTest, для всех версий Apache HTTP server  (модуль сетевого пентеста)  
    результат: вера в разработчиков, старые закрытые CVE все еще закрытые 
 
 
## стек технологий для проверки 
* nmap 
* агент, в виде edr или возможность удаленного выполнения команд на хосте 
* PenTest модуль с заранее описанными скриптами (BlackBox, BAS, anyelse) 
 
 
## требования 
### требования к сканнеру 
* скорость проверки (ресурсы необходимые на выполнение), на полу-пустом лабораторном стенде скан не должен занимать более 1 минуты 
* скан в режиме пен-тест не должен сломать систему или предупредить о том какие проверки могут вызвать негативные последствия, например DoS.  
* скан EDR не должен занимать первый приоритет процессора, так как может вызвать непреднамеренный DoS 
 
 
### требование к разработке сканнера 
* соответствие кода ТЗ эксперта 
* комментирование кода и описание применяемых функций 
* логгирование запуска функции, выполнения и полноценное описание ошибки в случае провала, с кодом ссылающимся на документацию 
* до запись в ТЗ какие модули/функции выполняют тот или иной блок. 
* при многократном переиспользовании вынос блоков в отдельную директорию, с максимально возможным описанием 
 
 
### требования к экспертной команде 
* понятное ТЗ, то есть ТЗ написанное по договоренностям с командой разработки и удовлетворяющее их требованиям 
* отзывчивость при вопросах от команды разработки 
* проработка возможных проблем при скане, описание возможных ошибок 
* тестирование, аппрув 
* поддержка в случае проблем 
 
 
## процессы (IDEF0 был бы более наглядным, но съест очень много времени)
0) анализ источника (приоритет, надо ли вообще); 
1) поиск информации по существующим источнику, документации, CVE; 
    + для поиска информации необходимо понимание какие базы используются, есть ли автоматизация, в каком виде она выдает информацию.   
    если автоматизации по разным базам нет, но уязвимость важная, то пройтись по всем существующим базам, разложить ее и осознать  
    в идеальном мире скрипты должны приносить только трендовые уязвимости, с сылкой на эксплойт, с указанием как часто используется ПО и т.д.
3) стендирование; 
    для стендирования нужно понимать используется ли автоматизация развертывания, используется ли большой лабороторный полигон и какие там правила вставки, с кем обсуждать, кто выделит сетевую адресацию.  
    в идеальном мире, должна быть тестовая инфраструктура, где уже есть домены, какая-то имитация жизнедеятельности, хосты разворачиваются указанием основных параметров, а также ОС, которая нужна, в процессе настройки эксперт описывает команды необходимые для установки, чтобы в будущем стенд можно было развернуть "одним нажатием" (для обновления данных по экспертизе). тогда и процесс будет в инструкции: как запустить развертывание и в каком формате сохранять команды необходмые для установки
2) написание ТЗ на автоматизацию поиска CVE для данного продукта; 
    + сайт вендора, как именно он отмечает свои уязвимости, как у него устроена нумерация? завязана ли она на mitre? формат представления патч-ноутс с закрытием уязвимостий, формат представления бюллетеней. 
    + есть ли каналы, которые специализируются на данном ПО, например сайты коммьюнити, где могут в прямом виде спрашивать когда и как закрыть определенную уязвимость
4) анализ конфигов и иных источников данных для модели; 
    + возможности по настройке, можно ли вообще харденить или максимальные конфигурирование источника - управления пользователями?
    + можно ли заполнять модель из событий? каких? где их включить и как собрать?
5) составление модели;  
    нужно понимание внутренней структуры модели и насколько она расширяема.  
6) написание ТЗ на аудит:   
    имея описание как праивльно формировать ТЗ, единый стандартый вид, постепенно наполняя его
    + краткое описание зачем
    + права доступа
    + команды в обговоренном виде (то есть дополнение команды, чтобы она доставала только нужные данные или описание как получить их (awk/grep/find) + сама команда)
    + указание в какое поле модели необходимо занести данные
    + может ли быть пустым, что делать в этом случае
    + какие могут быть ошибки (нехватка прав, отсутствие файла и т.д.) 
7) составление ТЗ на ПенТест (сбор скриптов, составление новых);  
    имея описание как праивльно формировать ТЗ, единый стандартый вид, постепенно наполняя его
    + краткое описание зачем
    + права доступа
    + команды в обговоренном виде
    + обработка выходных значений, какие данные свидетельствуют об успехе, какие о провале.
8) ревью ТЗ и модели
    + другими коллегами
    + разработчиками
8) ревью скриптов по ТЗ
    + разработчиками
    + автором ТЗ
9) ручное тестирование скриптов
    + на исходном стенде
    + после сброса к нулевому состоянию
    + после харденинга
10) автоматизация тестирования
    в идеальном мире: 
    + CI/CD по кусочкам (unit-тестирование), там где это возможно
    + раз в иногда:
        - автоматическое стендирование
        - автоматический запуск скриптов
        - валидация выходных параметров и времени выполнения (поиск деградаций)
11) поддержка по выходу новых версий, багов или новых важных CVE (возвращение на 1, но не с нуля)
 
 
### организационные вопросы 
* взаимодействие команд, в том числе неформальное, никто из команд не должен принижать заслуги другой команды, если есть возможность проведения совместных межкомандых мероприятий, которые покажут что в другом отделе тоже люди, неглупые люди, то это положительно скажется на итоговый продукт. 
* проработанный формат заведения задач*
* понимание стека технологий и возможностей команд. Общее представление кто в каком отделе хорош в каком направлении, касательно экспертов: какие ТЗ до этого писал, что было интересного в каждом, касательно разработки: ЯП под капотом, какие скрипты писал, какие ТЗ понравились, какие вызывают душевную боль до сих пор.
* а также обмен новыми знаниями, то есть если в сканнере происходят важные изменения, добавляется метод подключения или часть функций уходит в общие шаблонные функции, то это полезная информация, которую следует подсвечивать между командами, хотя бы короткими 15-минутными встречами раз в неделю, кому будет интересно сами придут за подробностями.
* доступ к трекеру и понимание загрузки команд (для руководителей, чтобы как-то распредлить нагрузку)
* умение вставлять в план задачи для минимально возможных швов между командами. Если в эксперта летит задача, которая точно перейдет в разработку, то задачу на разработку можно заводить сразу, ставя старт_тайм как время выполнение экспертной составляющей + 2 недели (форс-мажоры). это позволит минимизировать потери знаний эксперта и ускорит общее время выполнение. 
* оценка и минимизация задач пролетающих мимо стандартного пайплайна (сверху) (от этого никуда не деться, но постоянное смещение низкоуровневой фичи может привести к печальным последствиям) 

[*] что имеет ввиду под проработка формата задач и вообще вводных данных:  
все пункты работы с Checkbox-ами, отдельные поля под заполняемые данные  
Проще на примере организации деятельности по поддержкам сиема в ютреке (который на мой взгляд безумно гибкий):
1) для начала была собрана вся возможная внутренняя документация, вебинары, хорошие статьи
2) собраны источники по атакам, тот же exploit-db, hacktrix и т.д.
3) декомпозирован черный ящик поддержки по винтикам, вплоть до ТЗ надо писать сначала шапка - вот эта, таблица - вот эта и т.д. (именно с учетом существующих или обоговариваемых с разработкой условий)
4) потом из пуктов начали вырезаться избыточные шаги, итеративно, обсуждая с администраторами проектов, а также с людьми, которые не знакомы с поддержками
5) добавлены поля, куда при выполнение задачи необходимо было добавлять информацию, например: ссылки на ТЗ, расположение и креды стенда.
5) добавлены пункты про заполнение полей. Если есть поле "описание стенда" и есть пункт развертывание стенда, то следующий пункт после него "в поле описание стенда приложено расположение стенда и креды для доступа"
6) в пункт про заведение задачи на смежный отдел добавлялся шаблон заведения (автоматический) задачи, с автоматическим выставлением всех полей, которые можно заранее заполнить из главной задачи. 
то есть обобщая: создавая шаблон я пытался заранее описать все процессы, где могли бы возникнуть вопросы и автоматизацией минимизировать типовые операции, чтобы работа эксперта была исключительно в экспертизе (*и проставлении галочек).  

 
## человеко-ресурсы и временные рамки 
1) эксперт 1 месяц - минимальная работа то есть VM, минимальная модель (версия и где ее взять), либо 2 месяца (+ТЗ атак, модель достаточная для комплаенса) 
2) разработчик 2 недели - реализация всех ТЗ и тестирование, если с атаками, то еще 1-2 недели. 

максимальное время от взяли в работу → появилось в продукте: 4 месяца 
 
 
## Риски 
* отсутствие документации на конфигурирование, может увеличить срок реализации; 
* нераспространенность ПО и как следствие малая известность атак и уязвимостей, которые могут найтись в процессе, может оказаться что ВМ будет бесполезен и не отображать реальную уязвимость ПО и инфраструктуры; 
* отсутствие методов подключения сканнера, если придется добавлять фундаментальный функционал в сканнер, то срок его реализации вырастет; 
* плохие договоренности между командами, если эксперт не будет ревьювить своевременно разработчик может переключиться на другую задачу и получится бесконечное ожидание друг друга, что увеличит сроки. 
 